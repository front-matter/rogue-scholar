service: inveniordm
image: front-matter/rogue-scholar
servers:
  web:
    hosts:
      - 176.9.24.117
  worker:
    hosts:
      - 176.9.24.117
    cmd: celery -A invenio_app.celery worker --beat --events
  observability:
    hosts:
      - 176.9.24.117

proxy:
  ssl: true
  host: staging.rogue-scholar.org
  forward_headers: true
  app_port: 5000
  healthcheck:
    path: /ping
    #   interval: 90
    #   timeout: 10
  logging:
    request_headers:
      - Protocol
      - Host
      - Port
      - Path
      - Cache-Control
      - User-Agent
      - X-Forwarded-Proto
    response_headers:
      - X-Request-ID
      - X-Request-Start

registry:
  server: ghcr.io
  username: mfenner
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  context: .
  remote: ssh://root@176.9.24.117
  local: false
  cache:
    type: registry

env:
  clear:
    INVENIO_SITE_UI_URL: https://staging.rogue-scholar.org
    INVENIO_SITE_API_URL: https://staging.rogue-scholar.org/api
    # INVENIO_APP_ALLOWED_HOSTS: "['staging.rogue-scholar.org']"
    INVENIO_WSGI_PROXIES: 4
    # accessories db, cache, search
    POSTGRES_DB: inveniordm
    POSTGRES_USER: inveniordm
    INVENIO_CACHE_TYPE: redis
    INVENIO_CACHE_REDIS_URL: redis://inveniordm-cache:6379/0
    INVENIO_ACCOUNTS_SESSION_REDIS_URL: redis://inveniordm-cache:6379/1
    INVENIO_CELERY_RESULT_BACKEND: redis://inveniordm-cache:6379/2
    INVENIO_RATELIMIT_STORAGE_URL: redis://inveniordm-cache:6379/3
    INVENIO_COMMUNITIES_IDENTITIES_CACHE_REDIS_URL: redis://inveniordm-cache:6379/4
    INVENIO_BROKER_URL: redis://inveniordm-cache:6379/5
    INVENIO_CELERY_BROKER_URL: redis://inveniordm-cache:6379/5
    INVENIO_SEARCH_INDEX_PREFIX: invenio-rdm-
    INVENIO_THEME_SITENAME: Rogue Scholar
    INVENIO_THEME_FRONTPAGE_TITLE: "Science blogging on steroids."
    INVENIO_THEME_FRONTPAGE_SUBTITLE: "The Rogue Scholar science blog archive improves science blogs in important ways, including full-text search, long-term archiving, DOIs and metadata, and communities."
    INVENIO_THEME_LOGO: images/rogue-scholar-white.svg
    INVENIO_THEME_SHOW_FRONTPAGE_INTRO_SECTION: False
    INVENIO_RDM_ALLOW_EXTERNAL_DOI_VERSIONING: False
    INVENIO_LEGACY_URL: https://legacy.rogue-scholar.org
    INVENIO_DATACITE_ENABLED: False
    # mail
    INVENIO_MAIL_DEFAULT_SENDER: info@rogue-scholar.org
    INVENIO_SECURITY_EMAIL_SENDER: info@rogue-scholar.org
    INVENIO_APP_RDM_ADMIN_EMAIL_RECIPIENT: info@rogue-scholar.org
    INVENIO_MAIL_PORT: 465
    INVENIO_MAIL_SUPPRESS_SEND: True
    INVENIO_MAIL_USE_SSL: True
  secret:
    - INVENIO_SQLALCHEMY_DATABASE_URI
    - POSTGRES_PASSWORD
    - OPENSEARCH_INITIAL_ADMIN_PASSWORD
    - INVENIO_SECRET_KEY
    # mail
    - INVENIO_MAIL_SERVER
    - INVENIO_MAIL_USERNAME
    - INVENIO_MAIL_PASSWORD
    # oauth authentication
    - INVENIO_ORCID_CLIENT_ID
    - INVENIO_ORCID_CLIENT_SECRET
    - INVENIO_ORCID_APP_CREDENTIALS
    - INVENIO_GITHUB_APP_CREDENTIALS
accessories:
  db:
    image: paradedb/paradedb:0.15.22-pg17
    host: 176.9.24.117
    port: 5432
    directories:
      - data:/var/lib/postgresql/data
    env:
      clear:
        POSTGRES_USER: inveniordm
        POSTGRES_DB: inveniordm
      secret:
        - POSTGRES_PASSWORD
  cache:
    image: valkey/valkey:7.2.5
    host: 176.9.24.117
    port: 6379
    directories:
      - data:/data
  search:
    image: opensearchproject/opensearch:2.18.0
    host: 176.9.24.117
    port: 9200
    env:
      clear:
        discovery.type: single-node
        bootstrap.memory_lock: true
        OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
        DISABLE_INSTALL_DEMO_CONFIG: true
        DISABLE_SECURITY_PLUGIN: true
      secret:
        - OPENSEARCH_INITIAL_ADMIN_PASSWORD
    options:
      memory: 4g
      publish:
        - 9600:9600
  vector:
    image: timberio/vector:0.46.1-alpine
    roles:
      - web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    files:
      - config/vector.yml:/etc/vector/vector.yaml
volumes:
  - uploaded_data:/opt/invenio/var/instance/data
  - archived_data:/opt/invenio/var/instance/archive
deploy_timeout: 30
primary_role: web
